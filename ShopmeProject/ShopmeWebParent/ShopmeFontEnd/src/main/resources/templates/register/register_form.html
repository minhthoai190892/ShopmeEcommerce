<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments::page_head(${pageTitle},'none')"> </head>

<body>
    <div class="container-fluid">
        <!-- menu -->
        <div th:replace="navigation::head_menu"> </div>

        <div class="text-center">
            <h2>Customer Registration</h2>
        </div>
        <form th:action="@{/create_customer}" th:object="${customer}" method="post"
            style="max-width:600px ; margin: 0 auto;" onsubmit="return checkEmailUnique(this)">
            <div class="border border-secondary rounded p-3">
                <!-- First Name -->
                <div class="form-group row">
                    <label for="" class="col-sm-4 col-form-label">First Name:</label>
                    <div class="col-sm-8">
                        <input type="text" th:field="*{firstName}" class="form-control" required="required"
                            maxlength="45" minlength="2">
                    </div>
                </div>
                <!-- Last Name -->
                <div class="form-group row mt-2">
                    <label for="" class="col-sm-4 col-form-label">Last Name:</label>
                    <div class="col-sm-8">
                        <input type="text" th:field="*{lastName}" class="form-control" required="required"
                            maxlength="45" minlength="2">
                    </div>
                </div>
                <!-- E-mail -->
                <div class="form-group row mt-2">
                    <label for="" class="col-sm-4 col-form-label">E-mail:</label>
                    <div class="col-sm-8">
                        <input type="email" th:field="*{email}" class="form-control" required="required" maxlength="45"
                            minlength="8">
                    </div>
                </div>
                <!-- Password -->
                <div class="form-group row mt-2">
                    <label for="" class="col-sm-4 col-form-label">Password:</label>
                    <div class="col-sm-8">
                        <input type="password" th:field="*{password}" class="form-control" required="required"
                            maxlength="15" minlength="6"
                            oninput="checkPasswordMatch(document.getElementById('confirmPassword'))">
                    </div>
                </div>
                <!-- Re-type Password -->
                <div class="form-group row mt-2">
                    <label for="" class="col-sm-4 col-form-label">Re-type Password:</label>
                    <div class="col-sm-8">
                        <input type="password" id="confirmPassword" class="form-control" required="required"
                            oninput="checkPasswordMatch(this)" maxlength="15" minlength="6">
                    </div>
                </div>
                <!-- Phone Number -->
                <div class="form-group row mt-2">
                    <label for="" class="col-sm-4 col-form-label">Phone Number:</label>
                    <div class="col-sm-8">
                        <input type="text" th:field="*{phoneNumber}" class="form-control" required="required"
                            maxlength="15" minlength="8">
                    </div>
                </div>
                <!-- Address Line 1 -->
                <div class="form-group row mt-2">
                    <label for="" class="col-sm-4 col-form-label">Address Line 1:</label>
                    <div class="col-sm-8">
                        <input type="text" th:field="*{addressLine1}" class="form-control" required="required"
                            maxlength="64" minlength="3">
                    </div>
                </div>
                <!-- Address Line 2 -->
                <div class="form-group row mt-2">
                    <label for="" class="col-sm-4 col-form-label">Address Line 2:</label>
                    <div class="col-sm-8">
                        <input type="text" th:field="*{addressLine2}" class="form-control" maxlength="64" minlength="3">
                    </div>
                </div>
                <!-- City -->
                <div class="form-group row mt-2">
                    <label for="" class="col-sm-4 col-form-label">City:</label>
                    <div class="col-sm-8">
                        <input type="text" th:field="*{city}" class="form-control" maxlength="64" minlength="3">
                    </div>
                </div>
                <!-- Country -->
                <div class="form-group row mt-2">
                    <label for="" class="col-sm-4 col-form-label">Country:</label>
                    <div class="col-sm-8">
                        <select name="" id="" class="form-control" th:field="*{country}">
                            <th:block th:each=" country: ${listCountries}">
                                <option th:value="${country.id}">[[${country.name}]]</option>
                            </th:block>
                        </select>
                    </div>
                </div>
                <!-- State/Province -->
                <div class="form-group row mt-2">
                    <label for="" class="col-sm-4 col-form-label">State/Province:</label>
                    <div class="col-sm-8">
                        <input type="text" th:field="*{state}" class="form-control" list="listStates" maxlength="45"
                            minlength="3">
                        <datalist id="listStates"></datalist>
                    </div>
                </div>
                <!-- Postal Code -->
                <div class="form-group row mt-2">
                    <label for="" class="col-sm-4 col-form-label">Postal Code:</label>
                    <div class="col-sm-8">
                        <input type="text" th:field="*{postalCode}" class="form-control" maxlength="10" minlength="3">
                    </div>
                </div>
                <br>
                <div class="text-center">
                    <input type="submit" value="Create Account" class="btn btn-primary">
                </div>
            </div>
        </form>
        <br>
    </div>
    <div th:replace="fragments::modal_dialog"></div>

    <div th:replace="navigation::footer_menu"></div>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
        integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous">
        </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.min.js"
        integrity="sha384-7VPbUDkoPSGFnVtYi0QogXtr74QeVeeIs99Qfg5YCF+TidwNdjvaKZX19NZ/e6oz" crossorigin="anonymous">
        </script>
    <script src=https://code.jquery.com/jquery-3.6.0.min.js></script>
    <script type="text/JavaScript">
    var contextPath = "[[@{/}]]";
    var dropDownCountry;
    var dataListState;
    var fieldState;
    $(document).ready(function(){
        dropDownCountry = $("#country");
        dataListState=$("#listStates");
        fieldState=$("#state");
        dropDownCountry.on("change", function(){
            loadStatesForCountry();
            fieldState.val("").focus();
        });
        });
        function loadStatesForCountry(){
            selectedCountry = $("#country option:selected");
            
            countryId = selectedCountry.val();
            url=contextPath + "settings/list_states_by_country/"+countryId;
           
            $.get(url, function(responseJSON){
            dataListState.empty();
            $.each(responseJSON, function (index, state) { 
                $("<option>").val(state.name).text(state.name).appendTo(dataListState);
            });
            });
        }

            function checkPasswordMatch(confirmPassword) {
              //kiểm tra trường password và confirmPassword có giống nhau không
            if (confirmPassword.value != $("#password").val()) {
                //hiển thị thông báo mật khẩu không giống nhau
                confirmPassword.setCustomValidity("Passwords do not match!");
            }else{
                confirmPassword.setCustomValidity("");
            }
            console.log(confirmPassword +" "+$("#password").val());
            }

            function checkEmailUnique(form) {
        // xác định đường dẫn của dịch vụ web (UserRestService)
        // url = "[[@{/users/check_email}]]";//==> nhận được giá trị của trường biểu mẫu
        url = contextPath + "customers/check_unique_email";
        customerEmail = $("#email").val();
        // //đọc giá trị csrf của trang web
        csrfValue=$("input[name='_csrf']").val();
        // khai báo 1 mảng email người dùng và thông số của csrf
        //email: userEmail là tham số 
        params = { email: customerEmail,_csrf: csrfValue};
        // gọi AJAX đến dịch vụ web bằng phương thức post của JQuery
        //tải một trang web từ xa
        /*
        url: Đường dẫn trang web cần tải
        data: params
        callback:
        */
        $.post(url,params,function(response){
          // kiểm tra phản hồi của máy chủ để tiếp tục gửi đến máy chủ
        if (response=="OK") {
            form.submit();
        }else if (response =="Duplicated") {
            showWarningModal( "There is another customer having the email: "+customerEmail);
        }else{
            showErrorModal( "Unknown response from server");
        }
        }).fail(function(){
        showErrorModal( "Could not connect to the server");
        });
        return false;
    }
    
      // Modal Dialog
function showModalDialog(title, message) {
  $("#modalTitle").text(title);
  $("#modalBody").text(message);
  $("#modalDialog").modal("show");
}
function showWarningModal(message) {
  showModalDialog("Warning", message);
}
function showErrorModal(message) {
  showModalDialog("Error", message);
}
        </script>
</body>

</html>